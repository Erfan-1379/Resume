{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title_content %}پنل مدیریت{% endblock %}</title>

  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <link href="{% static 'css/admin.css' %}" rel="stylesheet">
  <link rel="icon" type="image/png" href="{% static 'images/misc/EYY_prev_ui.png' %}">
</head>
<body>
<div class="app-wrap" id="app">
  <nav class="nav-bar d-flex justify-content-between align-items-center">
    <div class="brand">
      <span class="dot"></span>
      <span>
        {% if request.user.get_full_name %}
          {{ request.user.get_full_name }}
        {% else %}
          {{ request.user.username }}
        {% endif %}
      </span>
    </div>
    <div class="toolbar">
      <div class="search">
        <input id="searchInput" class="form-control form-control-sm" type="search" placeholder="جست‌وجوی مدل‌ها..." aria-label="Search models">
        <i class="bi bi-search"></i>
      </div>
      <button id="themeToggle" class="btn btn-sm toggle" type="button" aria-label="تغییر تم">
        <i class="bi bi-moon-stars" id="themeIcon"></i>
        <span class="d-none d-sm-inline">تم</span>
      </button>
    </div>
  </nav>

  <main class="content">
    <div class="header">
      <div>
        <h1>داشبورد مدیریت</h1>
        <div class="sub">مدیریت آسان داده‌ها و محتوا</div>
      </div>
      <span class="badge-soft" id="countBadge">—</span>
    </div>

    <div class="grid" id="modelsGrid">
      {% block content %}
      {% for model in models %}
      <div class="col-card model-col" data-name="{{ model.display_name |lower }}">
        <section class="cardx" tabindex="0" aria-labelledby="title-{{ forloop.counter0 }}">
          <div class="title">
            <div id="title-{{ forloop.counter0 }}">{{ model.display_name  }}</div>
            <span class="badge-soft"><i class="bi bi-collection me-1"></i>{% with model.instances|length as l %}{{ l }} مورد{% endwith %}</span>
          </div>

          <div class="card-actions">
            <a class="btn btn-primaryx btn-sm flex-fill d-flex align-items-center justify-content-center gap-2 text-truncate"
               href="{{ model.add_url }}"
               data-bs-toggle="tooltip"
               data-bs-placement="bottom"
               title="افزودن {{ model.display_name }}">
              <i class="bi bi-plus-lg"></i>
              <span class="text-truncate">{{ model.display_name }}</span>
            </a>

            <div class="dropdown flex-fill">
              <button class="btn btn-ghost btn-sm w-100 d-flex align-items-center justify-content-center gap-2"
                      type="button"
                      id="editDropdown-{{ forloop.counter0 }}"
                      data-bs-toggle="dropdown"
                      data-bs-boundary="viewport"
                      data-bs-offset="0,8"
                      aria-expanded="false">
                <i class="bi bi-pencil-square"></i> ویرایش
                <i class="bi bi-chevron-down ms-1"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-end"
                   aria-labelledby="editDropdown-{{ forloop.counter0 }}"
                   role="menu">
                <div class="menu-head"><span><i class="bi bi-pencil me-1"></i> ویرایش {{ model.display_name  }}</span></div>
                <div class="menu-body">
                  <div class="list-scroll">
                    <ul class="list-unstyled m-0">
                      {% for instance in model.instances %}
                        <li>
                          <a class="menu-item dropdown-item" href="{{ instance.edit_url }}">
                            <i class="bi bi-file-earmark-text"></i>
                            <span>{{ instance.title|truncatewords:15 }}</span>
                          </a>
                        </li>
                      {% empty %}
                        <li class="menu-empty"><i class="bi bi-exclamation-triangle"></i> موردی وجود ندارد</li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <div class="dropdown flex-fill">
              <button class="btn btn-ghost btn-sm w-100 d-flex align-items-center justify-content-center gap-2"
                      type="button"
                      id="delDropdown-{{ forloop.counter0 }}"
                      data-bs-toggle="dropdown"
                      data-bs-boundary="viewport"
                      data-bs-offset="0,8"
                      aria-expanded="false">
                <i class="bi bi-trash3"></i> حذف
                <i class="bi bi-chevron-down ms-1"></i>
              </button>
              <div class="dropdown-menu dropdown-menu-end"
                   aria-labelledby="delDropdown-{{ forloop.counter0 }}"
                   role="menu">
                <div class="menu-head"><span><i class="bi bi-trash me-1"></i> حذف {{ model.display_name  }}</span></div>
                <div class="menu-body">
                  <div class="list-scroll">
                    <ul class="list-unstyled m-0">
                      {% for instance in model.instances %}
                        <li>
                          <a class="menu-item dropdown-item" href="{{ instance.delete_url }}">
                            <i class="bi bi-x-octagon"></i>
                            <span>{{ instance.title|truncatewords:15 }}</span>
                          </a>
                        </li>
                      {% empty %}
                        <li class="menu-empty"><i class="bi bi-exclamation-triangle"></i> موردی وجود ندارد</li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>
      {% endfor %}
      {% endblock %}
    </div>
  </main>

  <footer class="footer">
    <span>© {% now "Y" %} - Erfan Yaghoblo </span>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  (function () {
    const root = document.documentElement, btn = document.getElementById('themeToggle'), icon = document.getElementById('themeIcon');
    function setTheme(mode){
      if(mode==='light'){root.setAttribute('data-theme','light');icon.classList.remove('bi-moon-stars');icon.classList.add('bi-sun');}
      else{root.removeAttribute('data-theme');icon.classList.remove('bi-sun');icon.classList.add('bi-moon-stars');}
      localStorage.setItem('ui-theme',mode);
    }
    const saved = localStorage.getItem('ui-theme');
    setTheme(saved==='light'||saved==='dark'?saved:(matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'));
    btn.addEventListener('click',()=>setTheme(root.getAttribute('data-theme')==='light'?'dark':'light'));

    const input=document.getElementById('searchInput');
    const cols=[...document.querySelectorAll('.model-col')];
    const badge=document.getElementById('countBadge');
    function applyFilter(){
      const q=(input.value||'').trim().toLowerCase(); let visible=0;
      cols.forEach(col=>{
        const name=col.getAttribute('data-name')||'';
        const match=!q||name.includes(q);
        col.style.display=match?'':'none'; if(match) visible++;
      });
      badge.textContent=q?`${visible} نتیجه`:`${cols.length} مدل`;
    }
    input.addEventListener('input',applyFilter); applyFilter();

    document.querySelectorAll('.dropdown').forEach(dd=>{
      dd.addEventListener('show.bs.dropdown', (e)=>{
        const card = e.target.closest('.cardx');
        card?.classList.add('opening');
        document.querySelectorAll('.dropdown.show').forEach(opened=>{
          if(opened!==dd){
            bootstrap.Dropdown.getInstance(opened.querySelector('[data-bs-toggle="dropdown"]'))?.hide();
          }
        });
      });
      dd.addEventListener('hide.bs.dropdown', (e)=>{
        const card = e.target.closest('.cardx');
        setTimeout(()=>card?.classList.remove('opening'), 150);
      });
    });

    document.querySelectorAll('.cardx').forEach(card=>{
      card.addEventListener('keydown',(e)=>{
        const editBtn = card.querySelector('[id^="editDropdown-"]');
        const delBtn  = card.querySelector('[id^="delDropdown-"]');
        if(e.key==='Enter' && !e.ctrlKey && editBtn){ e.preventDefault(); editBtn.click(); }
        else if(e.key==='Enter' && e.ctrlKey && delBtn){ e.preventDefault(); delBtn.click(); }
      });
    });
  })();

  document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el);
  });
</script>
</body>
</html>
